<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-print-dialog.
  -
  - casper-print-dialog is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-print-dialog  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-print-dialog.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-wizard/casper-wizard.html">

<dom-module id="casper-print-dialog">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <casper-wizard-iframe-page id="Print" title="Impressão" next="Cancelar">
      <a slot="footer" id="DownloadLink">Download me</a>
    </casper-wizard-iframe-page>

  </template>

  <script>

    'use strict';

    /**
     * `casper-print-dialog`
     * Helper dialog to handle print jobs in casper applications
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperPrintDialog extends CasperWizard {

      static get is () {
        return 'casper-print-dialog';
      }

      ready () {
        super.ready();
        this.setAttribute('with-backdrop', true);
        this.addEventListener('opened-changed', e => this._onOpenedChanged(e));
        this.disablePrevious();
        this._iframe = this.$.Print.shadowRoot.querySelector('iframe');
        this.$.Print.iframeOverlay = Browser.isIos;
        this._boundPrintFrame = this._printFrame.bind(this);
        this.style.opacity = 1.0; // TODO animation
      }

      _onOpenedChanged (event) {
        if ( event.detail.value === true ) {
          this.setTitle(this.options.title || 'Impressão');
          this.setPageTitle('Print', this.options.pageTitle || 'Impressão Documento');
          this._clearIframe();
          switch ( this.options.action ) {
          case 'subscribe-download':
          case 'subscribe-print':
            if ( this.options['job-id'] ) {
              this.subscribeJob(this.options['job-id'], this.options.timeout || 5);
            }
            break;
          case 'epaper-download':
          case 'epaper-print':
          default:
            this.submitJob(this.options, this.options.timeout || 5);
            break;
          }
        }
      }

      _clearIframe () {
        let doc = this._iframe.contentDocument || this._iframe.contentWindow.document;
        doc.documentElement.innerHTML = "";
      }

      _printFrame () {
        this._iframe.onload = undefined;
        this._iframe.focus();
        this._iframe.contentWindow.print();

        if (!Browser.isIos ) {
          this.close();
        }
      }

      _print (url) {
        this._iframe.onload = this._boundPrintFrame;
        // ends here for now
        if ( Browser.isSafari || Browser.isFirefox) {
          this._xhrDownloadFile(url);
        } else {
          this._iframe.setAttribute('src', url);
        }
        this._iframe.setAttribute('data-src', url);
      }

      // Get the file through a http request
      _xhrDownloadFile (url) {
        //this._iframe.textContent = "Loading Loading Loading";
        let req = new window.XMLHttpRequest();
        req.responseType = 'arraybuffer';
        req.addEventListener('load', () => {
          if ( req.status === 200 ) {
            let localPdf = new window.Blob([req.response], {type: 'application/pdf'});
            this._iframe.setAttribute('src', window.URL.createObjectURL(localPdf));
          }
        });
        req.open('GET', url, true);
        req.send();
      }

      static getDateForFilename () {
        const  today = new Date();
        const  year = today.getFullYear();
        const  base_month = today.getMonth() + 1
        const  month = base_month.toString().length == 1 ? '0' + base_month : base_month;
        const  full_date = year + '-' + month;
        return full_date;
      }

      translateFilename (i18n_key, parameters) {
        if ( parameters.date === undefined ) {
          parameters.date = CasperPrintDialog.getDateForFilename();
        }
        try {
          return this.i18n.apply(this, [i18n_key, parameters]);
        } catch (e) {
          return i18n_key;
        }
      }

      jobCompletedOnPrint (status_code, message, response) {
        this.hideStatusAndProgress();
        this.$.DownloadLink.href   = response.public_link;
        this.$.DownloadLink.target = '_blank';

        if ( typeof this.options.on_job_completed === 'function' ) {
          if ( this.options.on_job_completed(status_code, message, response) === true ) {
            // Suppress default handling
            this.close();
            return;
          }
        }

        switch (this.options['action']) {
          case 'subscribe-print':
          case 'epaper-print':
            if ( Browser.isFirefox || Browser.isEdge || Browser.isIE) {
              try {
                let win = window.open(response.public_link, '_blank');
                win.focus();
                this.close();
              } catch (e) {
                console.warn("PDF blocked");
              }
            } else {
              this._print(response.public_link);
            }
            break;
          case 'subscribe-download':
          case 'epaper-download':
          default:
            if ( status_code == 200 && response.public_link !== undefined ) {
              this._iframe.setAttribute('src', response.public_link);
              this.close();
            }
            break;
        }
      }
    }

    window.customElements.define(CasperPrintDialog.is, CasperPrintDialog);
  </script>
</dom-module>

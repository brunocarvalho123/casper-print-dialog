<!doctype html>
<!--
  - Copyright (c) 2014-2016 Cloudware S.A. All rights reserved.
  -
  - This file is part of casper-print-dialog.
  -
  - casper-print-dialog is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-print-dialog  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-print-dialog.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../casper-wizard/casper-wizard.html">

<dom-module id="casper-print-dialog">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <casper-wizard-iframe-page id="Print" title="Impressão" next="Cancelar">
      <a slot="footer" id="DownloadLink">Download me</a>
    </casper-wizard-iframe-page>

  </template>

  <script>

    class Browser {
      // Firefox 1.0+
      static get isFirefox () {
        return typeof InstallTrigger !== 'undefined';
      }

      // Internet Explorer 6-11
      static get isIE () {
        return navigator.userAgent.indexOf('MSIE') !== -1 || !!document.documentMode;
      }

      // Edge 20+
      static get isEdge () {
        return !Browser.isIE && !!window.StyleMedia;
      }

      // Chrome 1+
      static get isChrome () {
        return !!window.chrome; // && !!window.chrome.webstore;
      }

      // At least Safari 3+: "[object HTMLElementConstructor]"
      static get isSafari ()  {
        return navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
               navigator.userAgent &&
               navigator.userAgent.indexOf('CriOS') == -1 &&
               navigator.userAgent.indexOf('FxiOS') == -1;
        //return Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0 ||
        //       navigator.userAgent.toLowerCase().indexOf('safari') !== -1;
      }

      static get isIos () {
        return navigator && (navigator.platform === 'iPad' || navigator.platform === 'iPhone');
      }

    }

    /**
     * `casper-print-dialog`
     * Helper dialog to handle print jobs in casper applications
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CasperPrintDialog extends CasperWizard {

      static get is () {
        return 'casper-print-dialog';
      }

      ready () {
        super.ready();
        if ( this.socket === undefined ) {
           this.socket = window.app.socket;
        }
        this.setAttribute('with-backdrop', true);
        this.addEventListener('opened-changed', e => this._onOpenedChanged(e));
        this.disablePrevious();
        this._iframe = this.$.Print.shadowRoot.querySelector('iframe');
        this._boundPrintFrame = this._printFrame.bind(this);
        this.style.opacity = 1.0; // TODO animation
      }

      setOptions (options) {
        super.setOptions(options);
        this.setTitle('Impressão');
        this.setPageTitle('Print', 'Impressão Documento');
      }

      _onOpenedChanged (event) {
        if ( event.detail.value === true ) {
          this._clearIframe();

          switch ( this.options['action'] ) {
          case 'subscribe-download':
          case 'subscribe-print':
            if ( this.options['job-id'] ) {
              this.subscribeJob(this.options['job-id'], /* timeout */ 60);
              return;
            }
            break;
          default:
            break;
          }
          this.close();
        }
      }

      _clearIframe () {
        let doc = this._iframe.contentDocument || this._iframe.contentWindow.document;
        doc.documentElement.innerHTML = "";
      }

      _printFrame () {
        //setTimeout(() => this.style.opacity = 0.0, 2);
        if ( Browser.isIE || Browser.isEdge ) {
          this._iframe.setAttribute('onload', undefined);
        } else {
          this._iframe.onload = undefined;
        }

        // If Edge or IE, try catch with execCommand
        if ( Browser.isIE || Browser.isEdge ) {
          try {
            this._iframe.contentWindow.document.execCommand('print', false, null);
          } catch (e) {
            this._iframe.contentWindow.print();
          }
        } else {
          // Other browsers
          this._iframe.contentWindow.print();
        }
        this.close();
      }

      _print (url) {
        if ( Browser.isIE || Browser.isEdge ) {
          this._iframe.setAttribute('onload', this._boundPrintFrame);
        } else {
          this._iframe.onload = this._boundPrintFrame;
        }
        if ( Browser.isSafari ) {
          console.log("Print via XHR !!!");
          this._xhrDownloadFile(url);
        } else {
          console.log("Print DIRECT");
          this._iframe.setAttribute('src', url);
        }
      }

      _download (url) {
        this._iframe.setAttribute('src', url);
        this.close();
      }

      // Get the file through a http request
      _xhrDownloadFile (url) {
        this._iframe.textContent = "Loading Loading Loading";
        let req = new window.XMLHttpRequest();
        req.responseType = 'arraybuffer';
        req.addEventListener('load', () => {
          let localPdf = new window.Blob([req.response], {type: 'application/pdf'});
          this._iframe.setAttribute('src', window.URL.createObjectURL(localPdf));
        });
        req.open('GET', url, true);
        req.send();
      }

      jobCompletedOnPrint (status_code, message, response) {
        let url = response.public_link.replace('http://127.0.0.1:3001', ''); // TODO martelada

        this.hideStatusAndProgress();
        switch (this.options['action']) {
        case 'subscribe-print':
          if ( Browser.isIos ) {
            this.$.DownloadLink.href = url;
            this.$.DownloadLink.target = '_blank';
          } else {
            if ( Browser.isFirefox ) {
              this._download(url);
            } else {
              this._print(url);
            }
          }
          break;
        case 'subscribe-download':
          if ( Browser.isIos ) {
            this.$.DownloadLink.href = url;
            this.$.DownloadLink.target = '_blank';
          } else {
            this._download(url);
          }
          break;
        default:
          break;
        }
      }
    }

    window.customElements.define(CasperPrintDialog.is, CasperPrintDialog);
  </script>
</dom-module>
